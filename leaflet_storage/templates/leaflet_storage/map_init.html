{% load leaflet_storage_tags %}
    <div id="map"></div>
    <script type="text/javascript">
        var MAP = new L.Storage.Map("map", {{ map_settings|notag|safe }});
        var popup = L.popup();

        /*********************************************
         *  ДЕТАЛИЗАЦИЯ  ОБЪЕКТА НА  КАРТЕ
         ********************************************/

        MAP.on('click', function(e) {
             /*********************************************
               TODO: пока  так ))
               Если включено несколько слоев,  и выбран объект на  котором находится  еще один)
               пока  берм  просто первого (случай  обозначение подстанции а на ней  обозначение объекта)

               с множественной передачей надо  подумать,  (так как на  сервере еще  делвать запрос  детальнеой
               информации об объекте - а связи в таблицах разные )

               на сервер передаем  название  приложения и  название модели

             /*********************************************/
             params = 'lat='.latlng.lat + "&lng=" + e.latlng.lng;
             visiblelayer = [];
             label = model = '';
             len_datalayer = e.sourceTarget.datalayers_index.length;
             datalayer= e.sourceTarget.datalayers_index;

             for (i= 0 ; i < len_datalayer; i++ ){
                  if (datalayer[i].isVisible() == true){
                      visiblelayer.push(e.sourceTarget.options.datalayers[i])
                  }
             }
             {#len_visible = visiblelayer.length;#}
             {#for (i = 0; i< len_visible; i++){#}
             {#    model = model + visiblelayer[i].label +','+ visiblelayer[i].object + ';'#}
             if (visiblelayer.length > 0){
                 params = params + "&lb=" + visiblelayer[0].label+ '&md='+visiblelayer[0].object;
             }


             $.ajax({
                url: "./api/v1/api_identify?" + params + "&f=json",
                type: "GET",
                success: function(data, textStatus, jqXHR){
                    var ct = jqXHR.getResponseHeader("content-type");
                     if (ct.indexOf('json') > -1) {
                            showinfo(data, e, true)
                        } else {
                            showinfo(JSON.parse(data),e, true)
                        }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log([textStatus, errorThrown])
                }
            });
        });

        function showinfo(jsondata, e, showPopup) {
            if (!jsondata || !jsondata.geometry) { return; }
            if (showPopup && jsondata.info && jsondata.info!='-'){
                  popup.setLatLng(e.latlng)
                                .setContent(jsondata.info)
                                .openOn(MAP);
            }
         };

    </script>
