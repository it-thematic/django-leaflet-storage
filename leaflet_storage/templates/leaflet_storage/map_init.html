{% load leaflet_storage_tags %}
    <div id="map"></div>
    <script type="text/javascript">
        var MAP = new L.Storage.Map("map", {{ map_settings|notag|safe }});


        MAP.on('click', function(e) {
            alert("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng)
             $.ajax({
                url: "./api/v1/api_identify?lat=" + e.latlng.lat + "&lng=" + e.latlng.lng + "&f=json",
                type: "GET",
                success: function(data, textStatus, jqXHR){
                    var ct = jqXHR.getResponseHeader("content-type");
                     if (ct.indexOf('json') > -1) {
                            alert(data);
                            showinfo(data, true)
                        } else {
                            showinfo(JSON.parse(data), true)
                        }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log([textStatus, errorThrown])
                }
            });
        });

        var popup = L.popup();
        var lsel = L.polygon([]).addTo(MAP);
        lsel.bindPopup(popup);

        function showinfo(jsondata, showPopup) {
            if (!jsondata || !jsondata.geometry) { return; }
            lsel.setLatLngs(L.GeoJSON.coordsToLatLngs(jsondata.geometry.coordinates, jsondata.geometry.type === 'Polygon' ? 1 : 2));
            if (showPopup && jsondata.info && jsondata.info!='-'){
                lsel.bindPopup(popup);
                lsel.setPopupContent(jsondata.info);
                lsel.openPopup(lsel.getCenter());
            }
            MAP.flyTo(lsel.getCenter());
         };

    </script>
